# Context
Filename: feishu_jssdk_auth_v2_task.md
Created On: 2026-01-29
Created By: AI
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
参考飞书官方示例代码，重新实现 JSSDK 鉴权逻辑。

# Project Overview
项目基于 Next.js，已集成飞书 Node SDK。之前尝试使用 SDK 的 `jssdk` 属性失败，现改用直接调用 REST API 的方式（参考官方 Demo）。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)
- 官方示例代码直接通过 `axios` 调用 REST API 获取 `jsapi_ticket`。
- 获取流程：`tenant_access_token` -> `jsapi_ticket` -> `SHA1 signature`。
- SDK 中的 `client.request` 或 `client.auth.tenantAccessToken.internal` 可以简化获取 token 的过程。
- 签名算法：SHA1。
- 缓存：需要缓存 `jsapi_ticket` 以避免频繁调用。

# Proposed Solution (Populated by INNOVATE mode)
1. **使用 SDK 通用请求方法**: 在 `lib/feishu/client.ts` 中，不依赖 `client.jssdk` 属性，而是使用 `client.request` 方法调用 `/open-apis/jssdk/ticket/get`。这是最稳妥且符合 SDK 设计的方式。
2. **实现内存缓存**: 保留 `ticketCache` 逻辑，减少 API 调用次数。
3. **严格签名生成**: 确保签名拼接顺序与官方 Demo 完全一致。
4. **前端配置 API**: 恢复 API 路由，以便前端可以动态获取配置。


# Implementation Plan (Generated by PLAN mode)
[Change Plan]
- File: `lib/feishu/types.ts`
- Rationale: 恢复 `JSSDKConfig` 类型定义。

- File: `lib/feishu/client.ts`
- Rationale: 使用 `client.request` 重新实现获取 ticket 和生成签名的逻辑。

- File: `app/api/feishu/config/route.ts`
- Rationale: 恢复 API 接口。

Implementation Checklist:
1. 在 `lib/feishu/types.ts` 中恢复 `JSSDKConfig` 类型定义。
2. 在 `lib/feishu/client.ts` 中实现 `getJSSDKConfig` 函数（使用 `client.request`）。
3. 重新创建 `app/api/feishu/config/route.ts`。


# Current Execution Step (Updated by EXECUTE mode when starting a step)
[Pending]

# Task Progress (Appended by EXECUTE mode after each step completion)
[Pending]

# Final Review (Populated by REVIEW mode)
[Pending]

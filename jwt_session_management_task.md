# Context
Filename: jwt_session_management_task.md
Created On: 2026-01-29
Created By: AI
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
引入 `jose` 库实现基于 JWT 的持久化登录态管理，并将 Token 存入加密的 HttpOnly Cookie 中。

# Project Overview
项目基于 Next.js 15+。目标是实现类似飞书官方示例的登录持久化，避免每次刷新页面都重新请求授权码。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)
- 需要安装 `jose` 处理 JWT。
- 需要添加 `JWT_SECRET` 到环境变量。
- 登录流程：Code 换用户信息 -> 签发 JWT -> 设置 HttpOnly Cookie。
- 恢复流程：前端初始化时检查 Session，如果 Cookie 有效则自动获取用户信息。

# Proposed Solution (Populated by INNOVATE mode)
1. **安装并集成 `jose`**: 引入轻量级、Edge 兼容的 JWT 库。
2. **后端工具封装**: 在 `lib/auth.ts` 中封装加密/解密逻辑，使用环境变量 `JWT_SECRET`。
3. **增强认证 API**: 
   - `login` 接口成功后签发 JWT 并写入 HttpOnly Cookie。
   - 新增 `me` 接口，支持通过 Cookie 直接返回当前用户信息，实现免 Code 恢复登录态。
4. **前端流程优化**: `FeishuProvider` 优先尝试从后端恢复 Session，仅在 Session 失效时才走飞书免登流程。


# Implementation Plan (Generated by PLAN mode)
[Change Plan]
- Action: 安装 `jose` 依赖。
- File: `lib/env.ts` -> 添加 `JWT_SECRET` 校验逻辑。
- File: `lib/auth.ts` -> 封装 JWT 签发与验证。
- File: `app/api/feishu/auth/login/route.ts` -> 登录成功后设置 HttpOnly Cookie。
- File: `app/api/auth/me/route.ts` -> 新增接口，用于通过 Cookie 自动恢复用户信息。
- File: `components/FeishuProvider.tsx` -> 修改初始化逻辑，优先尝试恢复 Session。

Implementation Checklist:
1. 安装 `jose` 依赖包。
2. 在 `lib/env.ts` 中加入 `JWT_SECRET`。
3. 创建 `lib/auth.ts` 及其工具函数。
4. 更新 `app/api/feishu/auth/login/route.ts` 以签发 JWT 并设置 Cookie。
5. 创建 `app/api/auth/me/route.ts` 路由。
6. 优化 `components/FeishuProvider.tsx` 的登录恢复逻辑。


# Current Execution Step (Updated by EXECUTE mode when starting a step)
[Pending]

# Task Progress (Appended by EXECUTE mode after each step completion)
[Pending]

# Final Review (Populated by REVIEW mode)
[Pending]

# Context
Filename: feishu_silent_login_task.md
Created On: 2026-01-29
Created By: AI
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
实现飞书网页应用免登录（免登）功能，包括后端换取用户信息接口和前端逻辑说明。

# Project Overview
项目基于 Next.js，已集成飞书 Node SDK。目标是允许用户在飞书客户端内打开应用时自动识别身份并登录。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)
- 免登核心：`tt.requestAuthCode` (前端) + `authen.v1.access_token` (后端)。
- 需要获取 `user_access_token` 以提取用户的 `open_id`, `name`, `avatar_url`。
- 后端需要一个 API 路由 `/api/feishu/auth/login` 接收 `code`。
- 需要考虑用户信息的类型定义。

# Proposed Solution (Populated by INNOVATE mode)
1. **核心逻辑封装**: 在 `lib/feishu/client.ts` 中实现 `getFeishuUserByCode(code: string)`。该函数将调用飞书 `authen.v1.access_token` 接口，将前端传来的临时授权码 `code` 转换为真实的用户信息。
2. **定义用户类型**: 在 `lib/feishu/types.ts` 中添加 `FeishuUser` 接口，包含 `open_id`, `name`, `avatar_url` 等常用字段。
3. **创建认证 API**: 实现 `app/api/feishu/auth/login/route.ts`，作为前端调用的端点。
4. **前端集成方案**: 建议在应用根组件或 Layout 中，当检测到处于飞书环境时，自动调用 `tt.requestAuthCode` 并请求上述 API 实现自动登录。


# Implementation Plan (Generated by PLAN mode)
[Change Plan]
- File: `lib/feishu/types.ts`
- Rationale: 添加 `FeishuUser` 类型定义，用于承载飞书返回的用户身份信息。

- File: `lib/feishu/client.ts`
- Rationale: 封装 `getFeishuUserByCode` 函数，利用飞书 SDK 完成 Token 交换。

- File: `app/api/feishu/auth/login/route.ts`
- Rationale: 创建处理免登请求的 API 路由，返回用户信息。

Implementation Checklist:
1. 在 `lib/feishu/types.ts` 中添加 `FeishuUser` 接口。
2. 在 `lib/feishu/client.ts` 中实现 `getFeishuUserByCode` 函数。
3. 创建 `app/api/feishu/auth/login/route.ts` 接口。


# Current Execution Step (Updated by EXECUTE mode when starting a step)
[Pending]

# Task Progress (Appended by EXECUTE mode after each step completion)
[Pending]

# Final Review (Populated by REVIEW mode)
[Pending]

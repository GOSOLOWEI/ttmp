# Context
Filename: feishu_integration_task.md
Created On: 2026-01-29
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
封装飞书（Feishu/Lark）集成模块，包括：
1. 客户端初始化封装。
2. 消息接收与回复（Webhook + API）。
3. 飞书任务（Tasks V2）创建与管理。
4. 多维表格（Bitable）作为 Prompt 数据源。

# Project Overview
项目已有基础的模型层 (`lib/models`) 和 Prompt 工程层 (`lib/prompts`)。飞书集成将作为业务入口和能力扩展。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)
- **SDK**: 已安装 `@larksuiteoapi/node-sdk`。
- **集成点**:
    - `lib/feishu`: 存放飞书核心逻辑（Client, Events, Messages, Tasks V2, Utils）。
    - `lib/prompts/datasources`: 扩展 `BitableDataSource`（支持分页与多格式）。
- **核心挑战**:
    - 飞书事件签名校验与 Webhook 适配。
    - Bitable 字段动态映射与分页。
    - 异步回复流控与错误统一处理。

# Proposed Solution (Populated by INNOVATE mode)
- **统一客户端管理**: 创建中心化的 `FeishuClient` 单例，并引入 `wrapRequest` 统一错误处理。
- **解耦事件处理**: 封装事件分发器与适配器。
- **增强多维表格数据源**: 支持多种格式化输出（JSON/Markdown/Text）及自动分页。
- **任务 V2 适配**: 升级到飞书任务 V2 接口，提供更强的生命周期管理。
- **消息构建器**: 引入 `FeishuMessageBuilder` 简化复杂消息构建。

# Implementation Plan (Generated by PLAN mode)
Implementation Checklist:
1. [Success] 创建 `lib/feishu/types.ts` 定义类型。
2. [Success] 实现 `lib/feishu/client.ts` 客户端单例。
3. [Success] 实现 `lib/feishu/messages.ts` 消息回复与构建器。
4. [Success] 实现 `lib/feishu/tasks.ts` 任务 V2 接口。
5. [Success] 实现 `lib/feishu/events.ts` 事件处理器。
6. [Success] 实现 `lib/prompts/datasources/feishu-bitable.ts` 增强版数据源。
7. [Success] 实现 `lib/feishu/utils.ts` 统一错误处理逻辑。
8. [Success] 更新 `lib/feishu/index.ts` 统一导出。

# Current Execution Step (Updated by EXECUTE mode when starting a step)
> Currently executing: "Completed"

# Task Progress (Appended by EXECUTE mode after each step completion)
* 2026-01-29 14:05
    * Step: 1-7 全量实现
    * Modifications: 创建了整个 `lib/feishu` 目录及 `BitableDataSource`
    * Change Summary: 完成了飞书消息、任务、多维表格的核心封装。
    * Reason: 执行飞书集成计划
    * Blockers: None
    * User Confirmation Status: Success
* 2026-01-29 14:15
    * Step: 增强功能迭代
    * Modifications: 引入 Tasks V2, FeishuMessageBuilder, 错误处理 utils, Bitable 分页与格式化。
    * Change Summary: 显著提升了飞书模块的健壮性与 Prompt 友好度。
    * Reason: 响应增强需求
    * Blockers: None
    * User Confirmation Status: Pending Confirmation

# Final Review (Populated by REVIEW mode)
[待填充]
